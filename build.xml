<project name="tritonus" default="dist" basedir=".">
	<target name="init">
		<tstamp/>
		<property name="src" value="src" />
		<property name="build" value="build" />
		<property name="dist"  value="dist" />
		<!--
			Remove the next line if you don't have jikes.
			In this case, javac will be used for compiling.
		-->
		<property name="build.compiler"  value="jikes" />
		<filter token="version" value="0.3.1" />
		<filter token="year" value="2000" />

		<available
			classname="grame.midishare.Midi"
			property="midishare-present" />
		<available
			classname="javazoom.jl.decoder.Decoder"
			property="javalayer-present" />
		<property
			name="java_ext_path"
			value="${java.home}/lib/ext" />
	</target>

	<target name="prepare" depends="init">
		<mkdir dir="${build}" />
	</target>

	<!--
		This target assumes that the javalayer code is in a directory
		'javalayer' that is parallel to 'tritonus'.
	-->
	<target name="build-javalayer" depends="init">
		<ant dir="../javalayer" />
	</target>

	<target name="compile" depends="prepare">
		<javac srcdir="${src}"
			destdir="${build}"
			includes="javax/sound/**,org/tritonus/**"
			excludes="org/tritonus/midi/device/midishare/**,org/tritonus/midi/old/**" />
	</target>

	<target name="compile-midishare"
		depends="prepare"
		if="midishare-present">
		<javac srcdir="${src}"
			destdir="${build}"
			includes="org/tritonus/midi/device/midishare/**" />
	</target>

	<target name="compile-libs"
		depends="prepare" >
		<exec
			dir="."
			executable="make"
			output="native0.log" >
			<arg line="-C src/lib/alsa" />
		</exec>
		<exec
			dir="."
			executable="make"
			output="native1.log" >
			<arg line="-C src/lib/esd" />
		</exec>
		<exec
			dir="."
			executable="make"
			output="native2.log" >
			<arg line="-C src/lib/lame" />
		</exec>
		<exec
			dir="."
			executable="make"
			output="native3.log" >
			<arg line="-C src/lib/saint" />
		</exec>
	</target>

	<target name="dist"
		depends="build-javalayer,compile,compile-midishare,compile-libs" >
		<mkdir dir="${dist}" />

		<jar jarfile="${dist}/tritonus_core.jar"
			basedir="${build}"
			includes="javax/sound/**,org/tritonus/core/**" />

		<jar jarfile="${dist}/tritonus_share.jar"
			basedir="${build}"
			includes="org/tritonus/share/" />

		<jar	jarfile="${dist}/tritonus_remaining.jar" >
			<fileset dir="${build}" >
				<include name="org/tritonus/lowlevel/" />
				<include name="org/tritonus/midi/" />
				<include name="org/tritonus/sampled/" />
			</fileset>
			<fileset dir ="${src}/packaging/tritonus_core" />
		</jar>

		<jar	jarfile="${dist}/tritonus_mp3.jar" >
			<fileset
				dir="${build}" >
				<include name="org/tritonus/sampled/convert/Mpeg*" />
				<include name="org/tritonus/sampled/file/Mpeg*" />
			</fileset>
			<fileset
				dir="${src}/packaging/tritonus_mp3" />
		</jar>

		<jar	jarfile="${dist}/tritonus_gsm.jar" >
			<fileset
				dir="${build}" >
				<include name="org/tritonus/lowlevel/gsm/" />
				<include name="org/tritonus/sampled/convert/gsm/" />
				<include name="org/tritonus/sampled/file/gsm/" />
			</fileset>
			<fileset
				dir="${src}/packaging/tritonus_gsm" />
		</jar>
	</target>

	<!--
		The following two targets should depend on uninstall, so that
		old files are safely removed. However, there is a problem with
		ant deleting symbolic links (VM crash), so it is left out
		for the moment.

		Also note that these targets only work for jdk >= 1.2.
	-->
	<target name="install" depends="dist">
		<copy
			todir="${java_ext_path}" >
			<fileset
				dir="${dist}" >
				<include name="*.jar" />
			</fileset>
		</copy>
	</target>

	<target name="install-link" depends="dist">
		<exec
			dir="${java_ext_path}"
			executable="ln" >
			<arg line="-s ${basedir}/${dist}/tritonus_core.jar ${java_ext_path}" />
		</exec>
		<exec
			dir="${java_ext_path}"
			executable="ln" >
			<arg line="-s ${basedir}/${dist}/tritonus_share.jar ${java_ext_path}" />
		</exec>
		<exec
			dir="${java_ext_path}"
			executable="ln" >
			<arg line="-s ${basedir}/${dist}/tritonus_remaining.jar ${java_ext_path}" />
		</exec>
		<exec
			dir="${java_ext_path}"
			executable="ln" >
			<arg line="-s ${basedir}/${dist}/tritonus_mp3.jar ${java_ext_path}" />
		</exec>
		<exec
			dir="${java_ext_path}"
			executable="ln" >
			<arg line="-s ${basedir}/${dist}/tritonus_gsm.jar ${java_ext_path}" />
		</exec>
	</target>

	<target name="uninstall" depends="init">
		<echo message="ext path: ${java_ext_path}" />
		<delete file="${java_ext_path}/tritonus*.jar" />
	</target>

	<target name="clean" depends="init">
		<delete dir="${build}" />
		<delete dir="${dist}" />
		<ant dir="../javalayer" target="clean" />
	</target>
</project>
