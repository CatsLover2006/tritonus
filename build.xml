<project name="tritonus" default="dist" basedir=".">
	<target name="init">
		<tstamp/>
		<property name="src" value="src" />
		<property name="build" value="build" />
		<property name="dist"  value="dist" />
		<filter token="version" value="0.3.1" />
		<filter token="year" value="2000" />
<!--
		<ant dir="../javalayer" />
-->
		<available
			classname="grame.midishare.Midi"
			property="midishare-present" />
		<available
			classname="javazoom.jl.decoder.Decoder"
			property="javalayer-present" />
		<property
			name="java_ext_path"
			value="${java.home}/lib/ext" />
	</target>

	<target name="prepare" depends="init">
		<mkdir dir="${build}" />
	</target>

	<target name="compile" depends="prepare">
		<javac srcdir="src"
			destdir="${build}"
			includes="javax/sound/**,org/tritonus/**"
			excludes="org/tritonus/midi/device/midishare/**,org/tritonus/midi/old/**"
			filtering="on"/>
	</target>

	<target name="compile-midishare"
		depends="prepare"
		if="midishare-present">
		<javac srcdir="src"
			destdir="${build}"
			includes="org/tritonus/midi/device/midishare/**"
			filtering="on"/>
	</target>

	<target name="compile-libs"
		depends="prepare" >
		<exec
			dir="."
			command="make -C src/lib/alsa"
			output="native0.log" />
		<exec
			dir="."
			command="make -C src/lib/esd"
			output="native1.log" />
		<exec
			dir="."
			command="make -C src/lib/lame"
			output="native2.log" />
		<exec
			dir="."
			command="make -C src/lib/saint"
			output="native3.log" />
	</target>

	<target name="dist"
		depends="compile,compile-midishare,compile-libs">
		<mkdir dir="${dist}" />
		<jar jarfile="${dist}/tritonus_core.jar"
			basedir="${build}"
			includes="javax/sound/,org/tritonus/core/" />
		<jar jarfile="${dist}/tritonus_share.jar"
			basedir="${build}"
			includes="org/tritonus/share/"/>
		<mkdir dir="${dist}/tritonus_remaining" />
		<copydir src="${build}" dest="${dist}/tritonus_remaining"
			includes="org/tritonus/lowlevel/,org/tritonus/midi/,org/tritonus/sampled/" />
		<copydir
			src="${src}/packaging/tritonus_core"
			dest="${dist}/tritonus_remaining"
			includes="**" />
		<jar
			jarfile="${dist}/tritonus_remaining.jar"
			basedir="${dist}/tritonus_remaining" />
		<mkdir dir="${dist}/tritonus_mp3" />
		<copydir src="${build}" dest="${dist}/tritonus_mp3"
			includes="org/tritonus/sampled/convert/Mpeg*,org/tritonus/sampled/file/Mpeg*" />
		<copydir
			src="${src}/packaging/tritonus_mp3"
			dest="${dist}/tritonus_mp3"
			includes="**" />
		<jar
			jarfile="${dist}/tritonus_mp3.jar"
			basedir="${dist}/tritonus_mp3" />
	</target>

	<target name="install" depends="dist">
		<copydir
			src="${dist}"
			dest="${java_ext_path}"
			includes="*.jar" />
	</target>

	<target name="install-link" depends="dist, uninstall">
		<exec
			dir="${java_ext_path}"
			command="ln -s ${dist}/*.jar ${java_ext_path}"
			output="/dev/null" />
	</target>

	<target name="uninstall" depends="init">
		<echo message="ext path: ${java_ext_path}" />
		<delete
			dir="${java_ext_path}"
			includes="./javalayer.jar" />
		<delete file="${java_ext_path}/javalayer.jar" />
	</target>

	<target name="clean" depends="init">
		<deltree dir="${build}" />
		<deltree dir="${dist}" />
	</target>
</project>
